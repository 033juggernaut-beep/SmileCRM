# ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã, –î–∏–∞–≥–Ω–æ–∑, –§–∏–Ω–∞–Ω—Å—ã

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

–í—Å–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã!

### 1. ‚úÖ –ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã –≤ –≤–∏–∑–∏—Ç–∞—Ö

**Backend:**
- `visits` —Ç–∞–±–ª–∏—Ü–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `medications TEXT`
- `VisitBase` –º–æ–¥–µ–ª—å: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `medications`
- `visits_service.py`: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç medications (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ)

**Frontend:**
- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ "–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã (–Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Å—Ö–µ–º–∞ –ø—Ä–∏—ë–º–∞)"
- –ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤: –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–∏–Ω–µ–º –±–ª–æ–∫–µ —Å –∏–∫–æ–Ω–∫–æ–π üíä
- –¢–∏–ø `Visit`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `medications`

### 2. ‚úÖ –î–∏–∞–≥–Ω–æ–∑ –ø–∞—Ü–∏–µ–Ω—Ç–∞

**Backend:**
- `patients` —Ç–∞–±–ª–∏—Ü–∞: –ø–æ–ª–µ `diagnosis` —Å–¥–µ–ª–∞–Ω–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º (`TEXT`)
- `PatientBase` –º–æ–¥–µ–ª—å: `diagnosis` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
- `patients_service.py`: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç diagnosis —á–µ—Ä–µ–∑ generic payload

**Frontend:**
- `AddPatientPage`: diagnosis –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
- `PatientDetailsPage`: diagnosis –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥ –∏–º–µ–Ω–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞
- –¢–∏–ø `Patient`: `diagnosis` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

### 3. ‚úÖ –§–∏–Ω–∞–Ω—Å—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞

**Backend:**
- **–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `patient_payments`**:
  - `id`, `patient_id`, `doctor_id`, `visit_id`
  - `amount`, `currency`, `paid_at`, `comment`
  - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - RLS policies

- **–ü–æ–ª—è –≤ `patients`**:
  - `treatment_plan_total NUMERIC(12,2)` - –æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–∞–Ω–∞
  - `treatment_plan_currency TEXT` - –≤–∞–ª—é—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é AMD)

- **–ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å `patient_payments_service.py`**:
  - `list_by_patient()` - —Å–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç
  - `create_payment()` - –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É
  - `get_finance_summary()` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞
  - `delete_payment()` - —É–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É

- **–ù–æ–≤—ã–π API `patient_finance.py`**:
  - `GET /patients/{id}/payments` - —Å–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç
  - `POST /patients/{id}/payments` - –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É
  - `GET /patients/{id}/finance-summary` - —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
  - `DELETE /patients/{id}/payments/{payment_id}` - —É–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É

**Frontend:**
- **–ù–æ–≤—ã–π API –∫–ª–∏–µ–Ω—Ç `patientFinance.ts`**
- **PatientDetailsPage - –±–ª–æ–∫ "üí∞ –§–∏–Ω–∞–Ω—Å—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞"**:
  - –í–≤–æ–¥ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–ª–∞–Ω–∞ –ª–µ—á–µ–Ω–∏—è
  - –¢—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏-—Å–≤–æ–¥–∫–∏:
    - üîµ –ü–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è (–æ–±—â–∞—è —Å—É–º–º–∞)
    - üü¢ –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ
    - üü† –û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å
  - –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã (—Å—É–º–º–∞ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
  - –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–ª–∞—Ç (–¥–∞—Ç–∞, —Å—É–º–º–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ/—Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend:
1. ‚úÖ `backend/app/db/migrations/012_add_medications_diagnosis_and_finance.sql` - –º–∏–≥—Ä–∞—Ü–∏—è
2. ‚úÖ `backend/app/models/dto.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏
3. ‚úÖ `backend/app/services/patient_payments_service.py` - NEW
4. ‚úÖ `backend/app/services/visits_service.py` - —É–∂–µ –≥–æ—Ç–æ–≤
5. ‚úÖ `backend/app/services/patients_service.py` - —É–∂–µ –≥–æ—Ç–æ–≤
6. ‚úÖ `backend/app/api/patient_finance.py` - NEW
7. ‚úÖ `backend/app/api/patients.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã finance –ø–æ–ª—è
8. ‚úÖ `backend/app/main.py` - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω patient_finance router

### Frontend:
1. ‚úÖ `frontend/src/api/patients.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã
2. ‚úÖ `frontend/src/api/patientFinance.ts` - NEW
3. ‚úÖ `frontend/src/pages/AddPatientPage.tsx` - diagnosis –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
4. ‚úÖ `frontend/src/pages/PatientDetailsPage.tsx` - medications + finance –±–ª–æ–∫

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

```sql
-- visits
ALTER TABLE visits ADD COLUMN medications TEXT;

-- patients  
ALTER TABLE patients ADD COLUMN diagnosis TEXT;
ALTER TABLE patients ADD COLUMN treatment_plan_total NUMERIC(12,2);
ALTER TABLE patients ADD COLUMN treatment_plan_currency TEXT DEFAULT 'AMD';

-- patient_payments (NEW TABLE)
CREATE TABLE patient_payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
  doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
  visit_id UUID REFERENCES visits(id) ON DELETE SET NULL,
  amount NUMERIC(12,2) NOT NULL CHECK (amount > 0),
  currency TEXT NOT NULL DEFAULT 'AMD',
  paid_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  comment TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## üöÄ –î–µ–ø–ª–æ–π

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

–ó–∞–π–¥–∏—Ç–µ –≤ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```sql
-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ 012_add_medications_diagnosis_and_finance.sql
```

### 2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥

```bash
git add -A
git commit -m "feat: Add medications, diagnosis, and patient finance tracking

- Add medications field to visits
- Make diagnosis optional for patients
- Add patient_payments table for tracking payments
- Add treatment plan total and currency to patients
- Create patient finance API and service
- Add finance UI block in PatientDetailsPage
- Update all frontend types and forms"

git push origin main
```

- **Vercel** –∑–∞–¥–µ–ø–ª–æ–∏—Ç frontend –∑–∞ 2-3 –º–∏–Ω—É—Ç—ã
- **Render** –∑–∞–¥–µ–ø–ª–æ–∏—Ç backend –∑–∞ 3-5 –º–∏–Ω—É—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Medications (–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã)
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
2. –í —Ñ–æ—Ä–º–µ "–°–æ–∑–¥–∞—Ç—å –≤–∏–∑–∏—Ç" –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è "–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã"
3. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç"
4. –í –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–∑–∏—Ç–æ–≤ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Å–∏–Ω–∏–π –±–ª–æ–∫ —Å –∏–∫–æ–Ω–∫–æ–π üíä –∏ —Ç–µ–∫—Å—Ç–æ–º –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–æ–≤

### –¢–µ—Å—Ç 2: Diagnosis (–î–∏–∞–≥–Ω–æ–∑)
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ë–ï–ó –¥–∏–∞–≥–Ω–æ–∑–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)
2. –ü–∞—Ü–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞—Ü–∏–µ–Ω—Ç–∞
4. –î–∏–∞–≥–Ω–æ–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ "‚Äî"

### –¢–µ—Å—Ç 3: Finance (–§–∏–Ω–∞–Ω—Å—ã)
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ –±–ª–æ–∫–∞ "üí∞ –§–∏–Ω–∞–Ω—Å—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞"
3. –í–≤–µ–¥–∏—Ç–µ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–∞–Ω–∞ –ª–µ—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500000)
4. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω"
5. –ö–∞—Ä—Ç–æ—á–∫–∞ "–ü–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è" –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å 500,000 AMD
6. –î–æ–±–∞–≤—å—Ç–µ –æ–ø–ª–∞—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100000 AMD —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º "–ü–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞")
7. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É"
8. –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—É—é –æ–ø–ª–∞—Ç—É
9. –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è:
   - –£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ: 100,000 AMD
   - –û—Å—Ç–∞–ª–æ—Å—å: 400,000 AMD

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è**: –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã - —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–ª–æ–º–∞—é—Ç—Å—è
2. **–í–∞–ª—é—Ç–∞**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é AMD, –Ω–æ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤ –±—É–¥—É—â–µ–º
3. **RLS**: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è patient_payments
4. **–ò–Ω–¥–µ–∫—Å—ã**: –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
5. **Decimal**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–µ–Ω—å–≥–∞–º–∏

## üìä API Endpoints (–Ω–æ–≤—ã–µ)

```
GET    /api/patients/{patient_id}/payments          - –°–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç
POST   /api/patients/{patient_id}/payments          - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É
GET    /api/patients/{patient_id}/finance-summary   - –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
DELETE /api/patients/{patient_id}/payments/{id}     - –£–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É
```

## üé® UI/UX

- **–ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã**: –°–∏–Ω–∏–π –±–ª–æ–∫ —Å –∏–∫–æ–Ω–∫–æ–π üíä, –ª–µ–≥–∫–æ –æ—Ç–ª–∏—á–∏–º –æ—Ç –∑–∞–º–µ—Ç–æ–∫
- **–§–∏–Ω–∞–Ω—Å—ã**: –¢—Ä–∏ —Ü–≤–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (—Å–∏–Ω—è—è/–∑–µ–ª–µ–Ω–∞—è/–æ—Ä–∞–Ω–∂–µ–≤–∞—è) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
- **–¢–∞–±–ª–∏—Ü–∞ –æ–ø–ª–∞—Ç**: –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è, —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
- **–§–æ—Ä–º—ã**: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π, –ø–æ–Ω—è—Ç–Ω—ã–µ placeholder'—ã

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ Backend API —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ Frontend UI —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –¢–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –ë–µ–∑ linter –æ—à–∏–±–æ–∫
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–ø–ª–æ–π

**–°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ** üöÄ

